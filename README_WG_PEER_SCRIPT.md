# Скрипт управления пирами WireGuard

## Описание

Скрипт `wg-add-peer.sh` - это интерактивный инструмент с текстовым интерфейсом (TUI) для создания пиров WireGuard на сервере.

## Требования

- Debian/Ubuntu или другая Linux система
- Права root
- Установленный WireGuard (`wireguard-tools`)
- Настроенный WireGuard сервер (файл `/etc/wireguard/wg0.conf` должен существовать)
- TUI библиотека (`dialog` или `whiptail`)

## Установка

### 1. Сделать скрипт исполняемым

```bash
chmod +x wg-add-peer.sh
```

### 2. Проверить/установить TUI библиотеки

См. файл `TUI_SETUP.md` для подробной инструкции.

**Быстрая установка:**
```bash
apt-get update
apt-get install -y dialog
```

### 3. Переместить скрипт в удобное место (опционально)

```bash
cp wg-add-peer.sh /usr/local/bin/wg-add-peer
chmod +x /usr/local/bin/wg-add-peer
```

Теперь скрипт можно запускать из любого места командой `wg-add-peer`.

## Использование

### Запуск скрипта

```bash
sudo ./wg-add-peer.sh
```

или если скрипт в PATH:

```bash
sudo wg-add-peer
```

### Процесс создания пира

1. **Ввод имени пира** - введите уникальное имя (только латиница, цифры, дефисы и подчеркивания)
2. **Выбор DNS серверов** - выберите из предложенных вариантов или введите свои
3. **Выбор режима маршрутизации** - выберите, какой трафик будет идти через VPN
4. **Подтверждение** - проверьте сводку и подтвердите создание

### Что делает скрипт

1. Генерирует пару ключей (приватный и публичный) для пира
2. Определяет следующий свободный IP адрес в подсети WireGuard (начиная с 10.0.0.2)
3. Добавляет пира в конфигурацию сервера (`/etc/wireguard/wg0.conf`)
4. Создает конфигурационный файл для клиента в `/etc/wireguard/peers_conf/<имя_пира>.conf`
5. Применяет изменения к работающему WireGuard интерфейсу
6. Выводит конфигурацию в STDOUT

## Выходные данные

### Конфигурационный файл пира

Создается файл: `/etc/wireguard/peers_conf/<имя_пира>.conf`

Этот файл содержит полную конфигурацию для клиента и может быть:
- Скопирован на клиентское устройство
- Импортирован в WireGuard клиент
- Передан пользователю для подключения

### Вывод в STDOUT

Скрипт также выводит конфигурацию в стандартный вывод (STDOUT), что позволяет:
- Перенаправить вывод в файл: `./wg-add-peer.sh > peer_config.conf`
- Скопировать конфигурацию из терминала
- Использовать в других скриптах

## Структура файлов

```
/etc/wireguard/
├── wg0.conf                    # Конфигурация сервера (обновляется скриптом)
├── server_private.key          # Приватный ключ сервера
├── server_public.key           # Публичный ключ сервера
├── peers_conf/                 # Директория с конфигурациями пиров
│   ├── peer1.conf
│   ├── peer2.conf
│   └── ...
└── <имя_пира>_private.key      # Приватные ключи пиров
└── <имя_пира>_public.key       # Публичные ключи пиров
```

## Пример использования

```bash
# Запуск скрипта
sudo ./wg-add-peer.sh

# В TUI интерфейсе:
# 1. Введите имя пира: laptop-user
# 2. Выберите DNS: Google (8.8.8.8, 8.8.4.4)
# 3. Выберите маршрутизацию: Весь трафик через VPN
# 4. Подтвердите создание

# Результат:
# - Пир добавлен в wg0.conf
# - Создан файл /etc/wireguard/peers_conf/laptop-user.conf
# - Конфигурация выведена в STDOUT
```

## Настройки по умолчанию

- **IP сервера:** 80.233.165.55
- **Порт:** 51820
- **Подсеть WireGuard:** 10.0.0.0/24
- **IP сервера в подсети:** 10.0.0.1
- **Интерфейс:** wg0
- **Keepalive:** 25 секунд

Эти настройки можно изменить в начале скрипта в разделе "Константы конфигурации".

## Безопасность

- Все ключи создаются с правами доступа 600 (только root)
- Конфигурационные файлы пиров имеют права 600
- Директория `peers_conf` создается с правами 700
- Скрипт проверяет права root перед выполнением

## Устранение проблем

### Ошибка: "WireGuard не установлен"

```bash
apt-get install wireguard wireguard-tools
```

### Ошибка: "Конфигурация WireGuard не найдена"

Убедитесь, что файл `/etc/wireguard/wg0.conf` существует и настроен согласно инструкции в `INSTALL.md`.

### Ошибка: "TUI библиотеки не найдены"

См. файл `TUI_SETUP.md` для инструкции по установке.

### Ошибка: "Не удалось найти свободный IP адрес"

Все IP адреса в подсети 10.0.0.0/24 заняты (от 10.0.0.2 до 10.0.0.254). Проверьте конфигурацию и удалите неиспользуемые пиры.

### Пир не подключается

1. Проверьте, что конфигурация применена:
   ```bash
   wg show wg0
   ```

2. Проверьте, что порт открыт в файрволе:
   ```bash
   iptables -L INPUT -n -v | grep 51820
   ```

3. Проверьте логи:
   ```bash
   journalctl -u wg-quick@wg0 -f
   ```

## Дополнительные возможности

### Просмотр всех созданных пиров

```bash
ls -la /etc/wireguard/peers_conf/
```

### Просмотр конфигурации пира

```bash
cat /etc/wireguard/peers_conf/<имя_пира>.conf
```

### Удаление пира

1. Удалите секцию `[Peer]` из `/etc/wireguard/wg0.conf`
2. Удалите файл конфигурации: `rm /etc/wireguard/peers_conf/<имя_пира>.conf`
3. Примените изменения:
   ```bash
   wg-quick down wg0
   wg-quick up wg0
   ```

## Примечания

- Скрипт автоматически определяет следующий свободный IP адрес
- Имена пиров должны быть уникальными
- При создании пира с существующим именем скрипт предложит перезаписать
- Изменения применяются к работающему WireGuard интерфейсу без полного перезапуска (если возможно)

