# Скрипт диагностики и исправления проблем с доступом в интернет через WireGuard

## Описание

Скрипт `wg-fix-internet.sh` автоматически диагностирует и исправляет проблемы с доступом в интернет через WireGuard VPN.

## Проблема

Клиенты успешно подключаются к WireGuard серверу, но не могут получить доступ в интернет через VPN.

## Быстрое решение

```bash
# Сделать скрипт исполняемым
chmod +x wg-fix-internet.sh

# Запустить диагностику
sudo ./wg-fix-internet.sh
```

Скрипт автоматически:
1. Проверит IP forwarding
2. Проверит правила iptables FORWARD
3. Проверит правило MASQUERADE
4. Предложит автоматически исправить найденные проблемы

## Что проверяет скрипт

### 1. IP forwarding
- Проверяет, включен ли IP forwarding (`net.ipv4.ip_forward = 1`)
- Проверяет, настроен ли он для постоянной работы (в `/etc/sysctl.conf`)

### 2. Правила iptables INPUT
- Проверяет наличие правила для принятия трафика с интерфейса `wg0`
- Должно быть правило:
  - `INPUT -i wg0 -j ACCEPT` (необходимо для того, чтобы клиенты могли пинговать сервер)

### 3. Правила iptables FORWARD
- Проверяет наличие правил для пересылки пакетов через интерфейс `wg0`
- Должны быть правила:
  - `FORWARD -i wg0 -j ACCEPT`
  - `FORWARD -o wg0 -j ACCEPT`

### 4. Правило MASQUERADE
- Проверяет наличие правила NAT для выхода в интернет
- Автоматически определяет внешний интерфейс из конфигурации WireGuard

### 5. Сохранение правил
- Проверяет, сохранены ли правила iptables для автозагрузки
- Включает `netfilter-persistent` если необходимо

## Использование

### Интерактивный режим

Просто запустите скрипт:

```bash
sudo ./wg-fix-internet.sh
```

Скрипт покажет результаты диагностики и предложит исправить проблемы автоматически.

### Что делает скрипт при исправлении

1. **Включает IP forwarding:**
   ```bash
   sysctl -w net.ipv4.ip_forward=1
   echo "net.ipv4.ip_forward=1" >> /etc/sysctl.conf
   ```

2. **Добавляет правило INPUT:**
   ```bash
   iptables -A INPUT -i wg0 -j ACCEPT
   ```

3. **Добавляет правила FORWARD:**
   ```bash
   iptables -A FORWARD -i wg0 -j ACCEPT
   iptables -A FORWARD -o wg0 -j ACCEPT
   ```

4. **Добавляет правило MASQUERADE:**
   ```bash
   iptables -t nat -A POSTROUTING -o <внешний_интерфейс> -j MASQUERADE
   ```

5. **Сохраняет правила:**
   ```bash
   iptables-save > /etc/iptables/rules.v4
   systemctl enable netfilter-persistent
   ```

## После исправления

После того как скрипт исправит проблемы, рекомендуется перезапустить WireGuard:

```bash
wg-quick down wg0
wg-quick up wg0
```

## Проверка работы

### На сервере:

```bash
# Проверить IP forwarding
sysctl net.ipv4.ip_forward
# Должно быть: net.ipv4.ip_forward = 1

# Проверить правило INPUT для wg0
iptables -L INPUT -n -v | grep wg0

# Проверить правила FORWARD
iptables -L FORWARD -n -v | grep wg0

# Проверить правило MASQUERADE
iptables -t nat -L POSTROUTING -n -v | grep MASQUERADE

# Проверить статус WireGuard
wg show
```

### На клиенте:

```bash
# Проверить подключение к серверу
ping 10.77.0.1

# Проверить доступ в интернет
ping 8.8.8.8

# Проверить DNS
nslookup google.com
```

## Требования

- Права root (sudo)
- Установленный WireGuard
- Настроенный интерфейс WireGuard (обычно `wg0`)
- iptables

## Пример вывода

```
========================================
Диагностика WireGuard Internet Access
========================================

[1/4] Проверка IP forwarding...
✗ IP forwarding выключен (текущее значение: 0)
⚠ IP forwarding не настроен для постоянной работы

[2/4] Проверка правил iptables...
✓ Правила FORWARD для wg0 настроены
✗ Правило MASQUERADE отсутствует

[3/4] Проверка интерфейса WireGuard...
✓ Интерфейс wg0 существует
✓ Интерфейс wg0 поднят
  IP адрес: 10.77.0.1/24

[4/4] Определение внешнего интерфейса...
✓ Внешний интерфейс найден в конфигурации: ens18

========================================
Сводка диагностики:
========================================
✗ IP forwarding выключен
⚠ IP forwarding не настроен для постоянной работы
✗ Правило MASQUERADE отсутствует

Обнаружены проблемы. Исправить автоматически? (y/n)
```

## Дополнительная информация

Подробная информация о ручной диагностике и устранении неполадок доступна в файле `TROUBLESHOOTING.md`.

## Примечания

- Скрипт автоматически определяет внешний интерфейс из конфигурации WireGuard (`/etc/wireguard/wg0.conf`)
- Если внешний интерфейс не найден в конфигурации, скрипт попытается определить его автоматически через `ip route`
- Все изменения сохраняются для автозагрузки после перезагрузки системы

