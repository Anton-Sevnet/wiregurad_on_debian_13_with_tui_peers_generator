# Устранение неполадок WireGuard

## Скрипт автоматической диагностики

Для автоматической диагностики и исправления проблем используйте скрипт `wg-fix-internet.sh`:

```bash
# Сделать скрипт исполняемым (если еще не сделано)
chmod +x wg-fix-internet.sh

# Запустить диагностику
sudo ./wg-fix-internet.sh
```

Скрипт автоматически проверит:
- ✅ IP forwarding (включение и постоянная настройка)
- ✅ Правила iptables FORWARD для wg0
- ✅ Правило MASQUERADE для NAT
- ✅ Сохранение правил для автозагрузки

После проверки скрипт предложит автоматически исправить найденные проблемы.

## Проблема: Клиенты подключаются, но нет доступа в интернет

Это самая распространенная проблема при настройке WireGuard. Обычно она связана с неправильной настройкой IP forwarding или правил iptables.

### Быстрое решение

Используйте скрипт автоматической диагностики и исправления:

```bash
sudo ./wg-fix-internet.sh
```

Скрипт проверит и автоматически исправит все проблемы.

### Причины проблемы

1. **IP forwarding выключен** - система не пересылает пакеты между интерфейсами
2. **Отсутствуют правила FORWARD** - файрвол блокирует пересылку пакетов через wg0
3. **Отсутствует правило MASQUERADE** - нет NAT для выхода в интернет

### Ручная диагностика

#### Шаг 1: Проверка IP forwarding

```bash
sysctl net.ipv4.ip_forward
```

**Ожидаемый результат:** `net.ipv4.ip_forward = 1`

**Если результат `0`:**
```bash
# Включить временно
sysctl -w net.ipv4.ip_forward=1

# Включить постоянно
echo "net.ipv4.ip_forward=1" >> /etc/sysctl.conf
```

#### Шаг 2: Проверка правил FORWARD

```bash
iptables -L FORWARD -n -v
```

**Ожидаемый результат:** Должны быть две строки с `wg0`:
```
ACCEPT     all  --  *      wg0     ...
ACCEPT     all  --  wg0    *       ...
```

**Если правил нет:**
```bash
iptables -A FORWARD -i wg0 -j ACCEPT
iptables -A FORWARD -o wg0 -j ACCEPT
```

#### Шаг 3: Проверка правила MASQUERADE

```bash
iptables -t nat -L POSTROUTING -n -v
```

**Ожидаемый результат:** Должна быть строка с `MASQUERADE` для внешнего интерфейса (например, `ens18`):
```
MASQUERADE  all  --  *      ens18   ...
```

**Если правила нет:**
```bash
# Определите внешний интерфейс
ip route | grep default

# Добавьте правило (замените ens18 на ваш интерфейс)
iptables -t nat -A POSTROUTING -o ens18 -j MASQUERADE
```

#### Шаг 4: Сохранение правил

После исправления обязательно сохраните правила:

```bash
# Создать директорию если не существует
mkdir -p /etc/iptables

# Сохранить правила
iptables-save > /etc/iptables/rules.v4

# Включить автозагрузку (если не включена)
systemctl enable netfilter-persistent
```

#### Шаг 5: Перезапуск WireGuard

```bash
wg-quick down wg0
wg-quick up wg0
```

### Проверка работы

После исправления проверьте:

1. **На сервере:**
```bash
# Проверить статус интерфейса
ip addr show wg0

# Проверить подключенных пиров
wg show

# Проверить статистику передачи
wg show wg0 transfer
```

2. **На клиенте:**
```bash
# Проверить подключение к серверу
ping 10.77.0.1

# Проверить доступ в интернет
ping 8.8.8.8

# Проверить DNS
nslookup google.com
```

### Дополнительные проверки

#### Проверка маршрутизации на клиенте

```bash
# На клиенте
ip route show

# Должен быть маршрут через wg0 для всего трафика (если AllowedIPs = 0.0.0.0/0)
# или только для подсети WireGuard
```

#### Проверка логов WireGuard

```bash
# На сервере
journalctl -u wg-quick@wg0 -n 50 -f
```

#### Проверка правил iptables подробно

```bash
# Все правила FORWARD
iptables -L FORWARD -n -v --line-numbers

# Все правила NAT
iptables -t nat -L -n -v --line-numbers

# Проверка конкретного интерфейса
iptables -L FORWARD -n -v | grep wg0
```

### Частые ошибки

1. **Неправильный внешний интерфейс в MASQUERADE**
   - Убедитесь, что используете правильный интерфейс (не `lo` или `wg0`)
   - Проверьте: `ip route | grep default`

2. **Правила добавлены, но не сохранены**
   - Правила теряются после перезагрузки
   - Всегда сохраняйте: `iptables-save > /etc/iptables/rules.v4`

3. **IP forwarding включен временно, но не постоянно**
   - После перезагрузки снова выключится
   - Добавьте в `/etc/sysctl.conf`: `net.ipv4.ip_forward=1`

4. **Конфликт с другими правилами файрвола**
   - Проверьте порядок правил: `iptables -L FORWARD -n -v --line-numbers`
   - Правила обрабатываются сверху вниз

### Если проблема сохраняется

1. Проверьте логи системы:
```bash
dmesg | tail -50
journalctl -xe
```

2. Проверьте, не блокирует ли внешний файрвол датацентра трафик

3. Проверьте конфигурацию клиента:
   - Правильный `Endpoint` (IP и порт сервера)
   - Правильный `PublicKey` сервера
   - `AllowedIPs = 0.0.0.0/0` для всего трафика через VPN

4. Проверьте, что WireGuard интерфейс поднят:
```bash
ip link show wg0
# Должно быть: state UP
```

5. Проверьте, что порт WireGuard открыт в файрволе:
```bash
iptables -L INPUT -n -v | grep 47770
# Должно быть правило ACCEPT для UDP порта 47770
```

## Другие проблемы

### Ошибка "resolvconf: command not found"

**Причина:** В конфигурации указан DNS, но утилита не установлена.

**Решение:** Удалите строку DNS из конфигурации сервера или установите:
```bash
apt install resolvconf -y
```

### Ошибка "Key is not the correct length or format"

**Причина:** В конфигурации указан путь к файлу вместо самого ключа.

**Решение:** Откройте файл ключа и скопируйте его содержимое в конфигурацию:
```bash
cat /etc/wireguard/server_private.key
# Скопируйте весь ключ (включая знак = в конце)
```

### Клиент не может подключиться

1. Проверьте, что порт открыт в файрволе:
```bash
iptables -L INPUT -n -v | grep <порт>
```

2. Проверьте, что WireGuard запущен:
```bash
systemctl status wg-quick@wg0
```

3. Проверьте логи:
```bash
journalctl -u wg-quick@wg0 -n 50
```

4. Проверьте конфигурацию клиента (правильный Endpoint, PublicKey)

5. Проверьте, что пир добавлен в конфигурацию сервера

