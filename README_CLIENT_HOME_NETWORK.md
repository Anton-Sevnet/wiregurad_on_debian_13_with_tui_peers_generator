# Настройка доступа к домашней сети клиента через WireGuard

## Сценарий

Клиент хочет получить доступ к своей домашней сети (например, `192.168.77.0/24`) через VPN сервер WireGuard.

## Пример

Клиент `anton_sevnet` имеет:
- IP в VPN: `10.77.0.2`
- Домашняя сеть: `192.168.77.0/24`

Нужно настроить так, чтобы через VPN можно было обращаться к устройствам в домашней сети клиента.

## Решение

### Шаг 1: Обновить AllowedIPs на сервере

На сервере в `/etc/wireguard/wg0.conf` для пира нужно добавить домашнюю сеть клиента в `AllowedIPs`:

```ini
[Peer]
# Публичный ключ пира: anton_sevnet
PublicKey = uldAjVywUbjTxIPvxn133x8OwgGdTyBLw+9eHS4IfGk=
AllowedIPs = 10.77.0.2/32, 0.0.0.0/0, 192.168.77.0/24
```

**Объяснение:**
- `10.77.0.2/32` - IP адрес пира в VPN сети (обязательно)
- `0.0.0.0/0` - весь трафик через VPN (если нужно)
- `192.168.77.0/24` - домашняя сеть клиента (добавляем для доступа к ней)

### Шаг 2: Использовать скрипт для обновления

Используйте скрипт `wg-update-peer-allowedips.sh`:

```bash
chmod +x wg-update-peer-allowedips.sh
./wg-update-peer-allowedips.sh
```

Скрипт:
1. Покажет список всех пиров
2. Попросит ввести PublicKey пира
3. Покажет текущие AllowedIPs
4. Попросит ввести новые AllowedIPs (можно указать несколько через запятую)
5. Обновит конфигурацию и применит изменения

### Шаг 3: Ручное обновление (альтернатива)

Если хотите обновить вручную:

```bash
# Отредактировать конфигурацию
nano /etc/wireguard/wg0.conf

# Найти секцию [Peer] для нужного пира и изменить AllowedIPs:
# Было: AllowedIPs = 10.77.0.2/32
# Стало: AllowedIPs = 10.77.0.2/32, 0.0.0.0/0, 192.168.77.0/24

# Применить изменения
wg set wg0 peer <PUBLIC_KEY> allowed-ips 10.77.0.2/32,0.0.0.0/0,192.168.77.0/24

# Или перезапустить WireGuard
wg-quick down wg0
wg-quick up wg0
```

### Шаг 4: Настроить маршрутизацию на клиенте (важно!)

На клиенте нужно настроить маршрутизацию, чтобы трафик к домашней сети шел через VPN.

**Вариант 1: Добавить статический маршрут на клиенте**

```bash
# На клиенте (Windows)
route add 192.168.77.0 mask 255.255.255.0 10.77.0.1

# На клиенте (Linux)
ip route add 192.168.77.0/24 via 10.77.0.1 dev wg0
```

**Вариант 2: Использовать AllowedIPs на клиенте**

В конфигурации клиента можно указать только нужные сети:

```ini
[Peer]
PublicKey = lVfCZt2tVxAVrQVUnqFXypkrTkOEnwRpbTvP7r/opQc=
AllowedIPs = 10.77.0.0/24, 192.168.77.0/24
Endpoint = 80.233.165.55:47770
PersistentKeepalive = 25
```

Но если клиент хочет доступ к интернету через VPN, нужно оставить `0.0.0.0/0`.

### Шаг 5: Настроить файрвол на клиенте

На клиенте нужно разрешить входящие соединения с VPN сети к домашней сети:

**Windows:**
- Настроить правила файрвола Windows для разрешения трафика между VPN и домашней сетью

**Linux:**
```bash
# Разрешить пересылку пакетов
sysctl -w net.ipv4.ip_forward=1

# Добавить правила iptables (если используется)
iptables -A FORWARD -i wg0 -o <домашний_интерфейс> -j ACCEPT
iptables -A FORWARD -i <домашний_интерфейс> -o wg0 -j ACCEPT
iptables -t nat -A POSTROUTING -o <домашний_интерфейс> -j MASQUERADE
```

## Важные замечания

### 1. Конфликты IP адресов

⚠️ **Внимание:** Убедитесь, что домашняя сеть клиента (`192.168.77.0/24`) не конфликтует с:
- VPN сетью сервера (`10.77.0.0/24`)
- Другими домашними сетями других клиентов
- Сетью самого сервера

### 2. Безопасность

Добавление домашней сети клиента в AllowedIPs означает, что:
- Сервер будет маршрутизировать трафик в эту сеть через клиента
- Другие клиенты VPN смогут обращаться к домашней сети этого клиента (если у них есть соответствующие маршруты)

Если нужна изоляция, не добавляйте домашние сети в AllowedIPs.

### 3. Производительность

Маршрутизация через VPN может добавить задержку. Для доступа к домашней сети лучше использовать прямое подключение, если возможно.

## Пример полной конфигурации

### На сервере (`/etc/wireguard/wg0.conf`):

```ini
[Interface]
PrivateKey = <SERVER_PRIVATE_KEY>
Address = 10.77.0.1/24
ListenPort = 47770
PostUp = iptables -t nat -A POSTROUTING -o ens18 -j MASQUERADE
PostDown = iptables -t nat -D POSTROUTING -o ens18 -j MASQUERADE

[Peer]
# Публичный ключ пира: anton_sevnet
PublicKey = uldAjVywUbjTxIPvxn133x8OwgGdTyBLw+9eHS4IfGk=
AllowedIPs = 10.77.0.2/32, 0.0.0.0/0, 192.168.77.0/24
```

### На клиенте (`peer.conf`):

```ini
[Interface]
PrivateKey = <CLIENT_PRIVATE_KEY>
Address = 10.77.0.2/24
DNS = 8.8.8.8, 8.8.4.4

[Peer]
PublicKey = <SERVER_PUBLIC_KEY>
AllowedIPs = 0.0.0.0/0
Endpoint = 80.233.165.55:47770
PersistentKeepalive = 25
```

## Проверка работы

После настройки проверьте:

```bash
# С другого клиента или сервера попробуйте пинговать устройство в домашней сети
ping 192.168.77.1

# Проверьте маршрутизацию
traceroute 192.168.77.1
```

## Дополнительная информация

- Скрипт `wg-update-peer-allowedips.sh` упрощает обновление AllowedIPs
- Всегда проверяйте конфликты IP адресов перед добавлением новых сетей
- Учитывайте вопросы безопасности при предоставлении доступа к домашним сетям

